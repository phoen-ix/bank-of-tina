{% extends "base.html" %}

{% block title %}Search Transactions – Bank of Tina{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-search me-1"></i> Search Transactions
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('search') }}">
            <!-- Main search bar -->
            <div class="input-group mb-3">
                <input class="form-control" type="search" name="q"
                       placeholder="Search transactions…" value="{{ q }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>

            <!-- Advanced filters toggle -->
            <div>
                <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                   href="#advancedFilters" role="button" aria-expanded="false"
                   aria-controls="advancedFilters" id="advancedToggle">
                    <i class="bi bi-sliders"></i> Advanced filters
                </a>
            </div>

            <div class="collapse mt-3" id="advancedFilters">
                <div class="row g-3">
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">Type</label>
                        <select class="form-select form-select-sm" name="type">
                            <option value="" {% if not tx_type %}selected{% endif %}>All types</option>
                            <option value="expense"    {% if tx_type == 'expense'    %}selected{% endif %}>Expense</option>
                            <option value="transfer"   {% if tx_type == 'transfer'   %}selected{% endif %}>Transfer</option>
                            <option value="deposit"    {% if tx_type == 'deposit'    %}selected{% endif %}>Deposit</option>
                            <option value="withdrawal" {% if tx_type == 'withdrawal' %}selected{% endif %}>Withdrawal</option>
                        </select>
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">User</label>
                        <select class="form-select form-select-sm" name="user">
                            <option value="" {% if not user_id %}selected{% endif %}>All users</option>
                            {% for u in all_users %}
                            <option value="{{ u.id }}" {% if user_id == u.id %}selected{% endif %}>{{ u.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">From date</label>
                        <input type="date" class="form-control form-control-sm" name="date_from" value="{{ date_from }}">
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">To date</label>
                        <input type="date" class="form-control form-control-sm" name="date_to" value="{{ date_to }}">
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">Min amount (€)</label>
                        <input type="text" inputmode="decimal" class="form-control form-control-sm"
                               name="amount_min" value="{{ amount_min }}" placeholder="0{{ decimal_sep }}00">
                    </div>
                    <div class="col-sm-6 col-md-3">
                        <label class="form-label small fw-semibold">Max amount (€)</label>
                        <input type="text" inputmode="decimal" class="form-control form-control-sm"
                               name="amount_max" value="{{ amount_max }}" placeholder="—">
                    </div>
                    <div class="col-sm-6 col-md-3 d-flex align-items-end">
                        <div class="form-check form-switch pb-1">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="has_receipt" name="has_receipt" value="1"
                                   {% if has_receipt %}checked{% endif %}>
                            <label class="form-check-label small fw-semibold" for="has_receipt">
                                Has attachment / receipt
                            </label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary btn-sm" type="submit">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% if not searched %}
    <p class="text-muted">Enter a search term or use advanced filters to find transactions across all months.</p>

{% elif results %}
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>From</th>
                            <th>To</th>
                            <th class="text-end">Amount</th>
                            <th>Receipt</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in results %}
                        <tr>
                            <td class="text-nowrap">{{ trans.date | localdt('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <span class="badge
                                    {% if trans.transaction_type == 'deposit' %}bg-success
                                    {% elif trans.transaction_type == 'withdrawal' %}bg-danger
                                    {% elif trans.transaction_type == 'expense' %}bg-primary
                                    {% else %}bg-secondary{% endif %}">
                                    {{ trans.transaction_type }}
                                </span>
                            </td>
                            <td>{{ trans.description }}</td>
                            <td>
                                {% if trans.from_user %}
                                    <a href="{{ url_for('user_detail', user_id=trans.from_user.id) }}">
                                        {{ trans.from_user.name }}
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if trans.to_user %}
                                    <a href="{{ url_for('user_detail', user_id=trans.to_user.id) }}">
                                        {{ trans.to_user.name }}
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end"><strong>€{{ trans.amount|money }}</strong></td>
                            <td>
                                {% if trans.receipt_path %}
                                    <a href="{{ url_for('view_receipt', filepath=trans.receipt_path) }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-paperclip"></i> View
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end text-nowrap">
                                <a href="{{ url_for('edit_transaction', transaction_id=trans.id) }}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form method="POST" action="{{ url_for('delete_transaction', transaction_id=trans.id) }}"
                                      class="d-inline"
                                      onsubmit="return confirm('Delete this transaction? Balances will be reversed.')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% if trans.items %}
                            <tr class="table-light">
                                <td colspan="8">
                                    <small class="ms-4">
                                        <strong>Items:</strong>
                                        {% for item in trans.items %}
                                            {{ item.item_name }} (€{{ item.price|money }}){% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </small>
                                </td>
                            </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted small">
            {{ results|length }} transaction{{ 's' if results|length != 1 else '' }}
            &middot; Total: €{{ (results|sum(attribute='amount'))|money }}
        </div>
    </div>

{% else %}
    <p class="text-muted">No transactions found for your search.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function () {
    var advancedParams = ['type', 'user', 'date_from', 'date_to', 'amount_min', 'amount_max', 'has_receipt'];
    var params = new URLSearchParams(window.location.search);
    var hasAdvanced = advancedParams.some(function (p) { return params.get(p); });
    if (hasAdvanced) {
        var el = document.getElementById('advancedFilters');
        if (el) {
            el.classList.add('show');
            var toggle = document.getElementById('advancedToggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'true');
        }
    }
})();
</script>
{% endblock %}
