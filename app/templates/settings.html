{% extends "base.html" %}

{% block title %}Settings - Bank of Tina{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-gear"></i> Settings</h2>
</div>

<ul class="nav nav-tabs mb-4" id="settingsTabs">
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-general"
                data-bs-toggle="tab" data-bs-target="#tab-general" type="button">
            <i class="bi bi-sliders"></i> General
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-email"
                data-bs-toggle="tab" data-bs-target="#tab-email" type="button">
            <i class="bi bi-envelope"></i> Email
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-common-items"
                data-bs-toggle="tab" data-bs-target="#tab-common-items" type="button">
            <i class="bi bi-bookmark-star"></i> Common
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-backup"
                data-bs-toggle="tab" data-bs-target="#tab-backup" type="button">
            <i class="bi bi-archive"></i> Backup
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-templates"
                data-bs-toggle="tab" data-bs-target="#tab-templates" type="button">
            <i class="bi bi-palette"></i> Templates
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="tab-btn-users"
                data-bs-toggle="tab" data-bs-target="#tab-users" type="button">
            <i class="bi bi-people"></i> Users
            {% if all_users %}
                <span class="badge bg-secondary ms-1">{{ all_users|length }}</span>
            {% endif %}
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- ── General tab ── -->
    <div class="tab-pane fade" id="tab-general">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-sliders"></i> General
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('settings_general') }}">
                    <div class="mb-4">
                        <label for="default_item_rows" class="form-label">Default empty item rows</label>
                        <input type="number" class="form-control" id="default_item_rows"
                               name="default_item_rows" value="{{ cfg.default_item_rows }}"
                               min="0" max="20" style="width: 120px">
                        <div class="form-text">
                            How many blank item rows to pre-fill when opening the Add Transaction form.
                            Set to 0 to keep the current behaviour (no rows until you click Add Item).
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="recent_transactions_count" class="form-label">
                            Recent transactions on dashboard
                        </label>
                        <input type="number" class="form-control" id="recent_transactions_count"
                               name="recent_transactions_count"
                               value="{{ cfg.recent_transactions_count }}"
                               min="0" max="50" style="width: 120px">
                        <div class="form-text">
                            How many recent transactions to show on the dashboard.
                            Set to 0 to hide the section entirely.
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="timezone" class="form-label">Timezone</label>
                        <select class="form-select" id="timezone" name="timezone" style="max-width: 360px">
                            {% for region, zones in timezone_groups.items() %}
                            <optgroup label="{{ region }}">
                                {% for tz in zones %}
                                <option value="{{ tz }}" {% if cfg.timezone == tz %}selected{% endif %}>
                                    {{ tz }}
                                </option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <div class="form-text">Used for displaying all dates and times throughout the app.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Decimal separator</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decimal_separator" id="sep_dot"
                                       value="." {% if cfg.decimal_separator == '.' %}checked{% endif %}>
                                <label class="form-check-label" for="sep_dot">Period &nbsp;<code>1.99</code></label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decimal_separator" id="sep_comma"
                                       value="," {% if cfg.decimal_separator == ',' %}checked{% endif %}>
                                <label class="form-check-label" for="sep_comma">Comma &nbsp;<code>1,99</code></label>
                            </div>
                        </div>
                        <div class="form-text">Used for displaying and entering all monetary amounts.</div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label">Currency symbol</label>
                      <select class="form-select w-auto" name="currency_symbol">
                        {% set currencies = [
                            ('€', 'Euro — €'),
                            ('$', 'US Dollar — $'),
                            ('£', 'British Pound — £'),
                            ('¥', 'Yen / Yuan — ¥'),
                            ('Fr', 'Swiss Franc — Fr'),
                            ('kr', 'Krone — kr'),
                            ('₹', 'Indian Rupee — ₹'),
                            ('A$', 'Australian Dollar — A$'),
                            ('C$', 'Canadian Dollar — C$'),
                            ('zł', 'Polish Złoty — zł'),
                            ('R$', 'Brazilian Real — R$'),
                            ('₪', 'Israeli Shekel — ₪'),
                        ] %}
                        {% for val, label in currencies %}
                          <option value="{{ val }}" {% if cfg.currency_symbol == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                      </select>
                      <div class="form-text">Symbol shown before all monetary amounts.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Dashboard</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show_email_on_dashboard"
                                   name="show_email_on_dashboard"
                                   {% if cfg.show_email_on_dashboard == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="show_email_on_dashboard">
                                Show email address in user balances table
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="site_admin_id" class="form-label">Site Admin</label>
                        <select class="form-select" id="site_admin_id" name="site_admin_id" style="max-width: 300px">
                            <option value="">— None —</option>
                            {% for user in all_users if user.is_active %}
                            <option value="{{ user.id }}" {% if cfg.site_admin_id == user.id|string %}selected{% endif %}>
                                {{ user.name }} ({{ user.email }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Used to send an admin summary email after each email run. Select a user or leave blank to disable.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-floppy"></i> Save
                    </button>
                </form>
            </div>
        </div>
    </div><!-- /tab-general -->

    <!-- ── Email tab ── -->
    <div class="tab-pane fade" id="tab-email">
        <div class="row g-4">

            <!-- Left: credentials -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-envelope"></i> Email Credentials
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('settings_email') }}">
                            <div class="mb-3">
                                <label for="smtp_server" class="form-label">SMTP Server</label>
                                <input type="text" class="form-control" id="smtp_server" name="smtp_server"
                                       value="{{ cfg.smtp_server }}" placeholder="smtp.gmail.com">
                            </div>
                            <div class="mb-3">
                                <label for="smtp_port" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port"
                                       value="{{ cfg.smtp_port }}" placeholder="587">
                            </div>
                            <div class="mb-3">
                                <label for="smtp_username" class="form-label">SMTP Username</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username"
                                       value="{{ cfg.smtp_username }}" autocomplete="username">
                            </div>
                            <div class="mb-3">
                                <label for="smtp_password" class="form-label">SMTP Password</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password"
                                       placeholder="{{ '•••••••••' if cfg.smtp_password else '' }}"
                                       autocomplete="current-password">
                                {% if cfg.smtp_password %}
                                    <div class="form-text">Leave blank to keep the existing password.</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="from_email" class="form-label">From Email</label>
                                <input type="email" class="form-control" id="from_email" name="from_email"
                                       value="{{ cfg.from_email }}">
                            </div>
                            <div class="mb-3">
                                <label for="from_name" class="form-label">From Name</label>
                                <input type="text" class="form-control" id="from_name" name="from_name"
                                       value="{{ cfg.from_name }}">
                            </div>

                            <hr>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                           id="email_enabled" name="email_enabled" value="1"
                                           {% if cfg.email_enabled == '1' %}checked{% endif %}>
                                    <label class="form-check-label" for="email_enabled">
                                        Enable email sending
                                    </label>
                                </div>
                                <div class="form-text">
                                    When off, both manual "Send Now" and the auto-schedule will do nothing.
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                           id="email_debug" name="email_debug" value="1"
                                           {% if cfg.email_debug == '1' %}checked{% endif %}>
                                    <label class="form-check-label" for="email_debug">
                                        Debug mode — log runs to DB and show errors in the UI
                                    </label>
                                </div>
                                <div class="form-text">
                                    When on, every send run is written to the debug log below and SMTP errors are shown as flash notifications.
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                           id="admin_summary_email" name="admin_summary_email" value="1"
                                           {% if cfg.admin_summary_email == '1' %}checked{% endif %}
                                           {% if not cfg.site_admin_id %}disabled{% endif %}>
                                    <label class="form-check-label" for="admin_summary_email">
                                        Send admin summary email
                                    </label>
                                </div>
                                <div class="form-text">
                                    {% if cfg.site_admin_id %}
                                        After each email run, send a full overview of all active users' balances to the site admin.
                                    {% else %}
                                        No site admin is configured. Set one in <strong>General</strong> to enable this option.
                                    {% endif %}
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-floppy"></i> Save Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right: Send Now + Schedule -->
            <div class="col-lg-6 d-flex flex-column gap-4">

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-send"></i> Send Now
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Send a balance-update email to every active user immediately using
                            the credentials configured on the left.
                        </p>
                        <form method="POST" action="{{ url_for('settings_send_now') }}">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-send-fill"></i> Send Emails Now
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock"></i> Auto-Schedule
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('settings_schedule') }}">

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="schedule_enabled" name="schedule_enabled" value="1"
                                       {% if cfg.schedule_enabled == '1' %}checked{% endif %}
                                       onchange="toggleScheduleFields(this)">
                                <label class="form-check-label" for="schedule_enabled">
                                    Enable automatic schedule
                                </label>
                            </div>

                            <div id="schedule_fields" {% if cfg.schedule_enabled != '1' %}style="display:none"{% endif %}>

                                <div class="mb-3">
                                    <label class="form-label">Day</label>
                                    <select class="form-select" name="schedule_day">
                                        <option value="*"   {% if cfg.schedule_day == '*'   %}selected{% endif %}>Every day</option>
                                        <option value="mon" {% if cfg.schedule_day == 'mon' %}selected{% endif %}>Monday</option>
                                        <option value="tue" {% if cfg.schedule_day == 'tue' %}selected{% endif %}>Tuesday</option>
                                        <option value="wed" {% if cfg.schedule_day == 'wed' %}selected{% endif %}>Wednesday</option>
                                        <option value="thu" {% if cfg.schedule_day == 'thu' %}selected{% endif %}>Thursday</option>
                                        <option value="fri" {% if cfg.schedule_day == 'fri' %}selected{% endif %}>Friday</option>
                                        <option value="sat" {% if cfg.schedule_day == 'sat' %}selected{% endif %}>Saturday</option>
                                        <option value="sun" {% if cfg.schedule_day == 'sun' %}selected{% endif %}>Sunday</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Time <span class="text-muted">(24 h)</span></label>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select w-auto" name="schedule_hour">
                                            {% for h in range(24) %}
                                            <option value="{{ h }}" {% if cfg.schedule_hour|int == h %}selected{% endif %}>
                                                {{ '%02d'|format(h) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="fw-bold fs-5">:</span>
                                        <select class="form-select w-auto" name="schedule_minute">
                                            {% set stored_min = (cfg.schedule_minute|int // 5) * 5 %}
                                            {% for m in range(0, 60, 5) %}
                                            <option value="{{ m }}" {% if stored_min == m %}selected{% endif %}>
                                                {{ '%02d'|format(m) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                {% if cfg.schedule_enabled == '1' %}
                                {% set day_labels = {'*': 'every day', 'mon': 'every Monday',
                                                     'tue': 'every Tuesday', 'wed': 'every Wednesday',
                                                     'thu': 'every Thursday', 'fri': 'every Friday',
                                                     'sat': 'every Saturday', 'sun': 'every Sunday'} %}
                                <div class="alert alert-success py-2 mb-3">
                                    <i class="bi bi-check-circle"></i>
                                    Emails will be sent <strong>{{ day_labels.get(cfg.schedule_day, cfg.schedule_day) }}</strong>
                                    at <strong>{{ '%02d:%02d'|format(cfg.schedule_hour|int, cfg.schedule_minute|int) }}</strong>
                                    <span class="text-muted">({{ cfg.timezone }})</span>.
                                </div>
                                {% endif %}

                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-floppy"></i> Save Schedule
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>

        {% if cfg.email_debug == '1' %}
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-text"></i> Email Debug Log</span>
                <form method="POST" action="{{ url_for('settings_email_clear_log') }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Clear the entire email debug log?')">
                        <i class="bi bi-trash"></i> Clear Log
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if email_logs %}
                <pre class="bg-dark text-light p-3 rounded small mb-0" style="max-height: 400px; overflow-y: auto; font-size: 0.78rem;">{% for log in email_logs %}{{ log.sent_at.strftime('%Y-%m-%d %H:%M') }} [{{ log.level|upper }}] {% if log.recipient %}{{ '%-40s'|format(log.recipient) }} {% endif %}{{ log.message }}
{% endfor %}</pre>
                {% else %}
                <p class="text-muted small mb-0">No log entries yet. Send emails to generate log entries.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div><!-- /tab-email -->

    <!-- ── Common tab ── -->
    <div class="tab-pane fade" id="tab-common-items">

        <!-- Card 1 — Global toggle -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-toggle-on"></i> Common Autocomplete
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('settings_common') }}">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="common_enabled" name="common_enabled" value="1"
                               {% if cfg.common_enabled == '1' %}checked{% endif %}>
                        <label class="form-check-label" for="common_enabled">
                            Enable Common autocomplete feature
                        </label>
                    </div>
                    <div class="form-text mb-3">
                        When off, all autocomplete suggestions (item names, descriptions, prices) are disabled across the app.
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-floppy"></i> Save
                    </button>
                </form>
            </div>
        </div>

        <!-- Card 2 — Item Names -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-bookmark-star"></i> Item Names
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    These appear as autocomplete suggestions in expense item name fields.
                </p>
                <form method="POST" action="{{ url_for('add_common_item') }}" class="d-flex gap-2 mb-3">
                    <input type="text" class="form-control" name="name" placeholder="New item name" required>
                    <button type="submit" class="btn btn-success text-nowrap">
                        <i class="bi bi-plus"></i> Add
                    </button>
                </form>
                {% if common_items %}
                <div class="d-flex flex-wrap gap-2 mb-4">
                    {% for item in common_items %}
                    <div class="badge bg-light text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ item.name }}
                        <form method="POST" action="{{ url_for('delete_common_item', item_id=item.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-danger lh-1"
                                    title="Remove" onclick="return confirm('Remove \'{{ item.name }}\' from common items?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-4">No common items saved yet.</p>
                {% endif %}

                <hr>
                <h6 class="text-muted mb-1">Blacklist</h6>
                <p class="text-muted small mb-2">Values listed here are never auto-collected, even if they meet the threshold.</p>
                <form method="POST" action="{{ url_for('add_common_blacklist') }}" class="d-flex gap-2 mb-3">
                    <input type="hidden" name="type" value="item">
                    <input type="text" class="form-control" name="value" placeholder="Item name to blacklist" required>
                    <button type="submit" class="btn btn-outline-secondary text-nowrap">
                        <i class="bi bi-plus"></i> Add to blacklist
                    </button>
                </form>
                {% set item_blacklist = common_blacklist | selectattr('type', 'equalto', 'item') | list %}
                {% if item_blacklist %}
                <div class="d-flex flex-wrap gap-2">
                    {% for bl in item_blacklist %}
                    <div class="badge bg-warning text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ bl.value }}
                        <form method="POST" action="{{ url_for('delete_common_blacklist', item_id=bl.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-dark lh-1"
                                    title="Remove" onclick="return confirm('Remove \'{{ bl.value }}\' from item blacklist?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">No blacklisted item names.</p>
                {% endif %}
            </div>
        </div>

        <!-- Card 3 — Descriptions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-chat-left-text"></i> Descriptions
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    These appear as autocomplete suggestions in the transaction description field.
                </p>
                <form method="POST" action="{{ url_for('add_common_description') }}" class="d-flex gap-2 mb-3">
                    <input type="text" class="form-control" name="value" placeholder="New description" required>
                    <button type="submit" class="btn btn-success text-nowrap">
                        <i class="bi bi-plus"></i> Add
                    </button>
                </form>
                {% if common_descriptions %}
                <div class="d-flex flex-wrap gap-2 mb-4">
                    {% for desc in common_descriptions %}
                    <div class="badge bg-light text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ desc.value }}
                        <form method="POST" action="{{ url_for('delete_common_description', item_id=desc.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-danger lh-1"
                                    title="Remove" onclick="return confirm('Remove \'{{ desc.value }}\' from common descriptions?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-4">No common descriptions saved yet.</p>
                {% endif %}

                <hr>
                <h6 class="text-muted mb-1">Blacklist</h6>
                <p class="text-muted small mb-2">Values listed here are never auto-collected, even if they meet the threshold.</p>
                <form method="POST" action="{{ url_for('add_common_blacklist') }}" class="d-flex gap-2 mb-3">
                    <input type="hidden" name="type" value="description">
                    <input type="text" class="form-control" name="value" placeholder="Description to blacklist" required>
                    <button type="submit" class="btn btn-outline-secondary text-nowrap">
                        <i class="bi bi-plus"></i> Add to blacklist
                    </button>
                </form>
                {% set desc_blacklist = common_blacklist | selectattr('type', 'equalto', 'description') | list %}
                {% if desc_blacklist %}
                <div class="d-flex flex-wrap gap-2">
                    {% for bl in desc_blacklist %}
                    <div class="badge bg-warning text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ bl.value }}
                        <form method="POST" action="{{ url_for('delete_common_blacklist', item_id=bl.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-dark lh-1"
                                    title="Remove" onclick="return confirm('Remove \'{{ bl.value }}\' from description blacklist?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">No blacklisted descriptions.</p>
                {% endif %}
            </div>
        </div>

        <!-- Card 4 — Prices -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-currency-euro"></i> Prices
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    These appear as autocomplete suggestions in the expense item price fields.
                </p>
                <form method="POST" action="{{ url_for('add_common_price') }}" class="d-flex gap-2 mb-3">
                    <input type="text" inputmode="decimal" class="form-control" name="value" placeholder="Price (e.g. 3{{ cfg.decimal_separator }}50)"
                           required style="max-width: 200px">
                    <button type="submit" class="btn btn-success text-nowrap">
                        <i class="bi bi-plus"></i> Add
                    </button>
                </form>
                {% if common_prices %}
                <div class="d-flex flex-wrap gap-2 mb-4">
                    {% for price in common_prices %}
                    <div class="badge bg-light text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ currency_symbol }}{{ price.value|money }}
                        <form method="POST" action="{{ url_for('delete_common_price', item_id=price.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-danger lh-1"
                                    title="Remove" onclick="return confirm('Remove {{ currency_symbol }}{{ price.value|money }} from common prices?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-4">No common prices saved yet.</p>
                {% endif %}

                <hr>
                <h6 class="text-muted mb-1">Blacklist</h6>
                <p class="text-muted small mb-2">Prices listed here are never auto-collected, even if they meet the threshold. Enter as decimal (e.g. 3{{ cfg.decimal_separator }}50).</p>
                <form method="POST" action="{{ url_for('add_common_blacklist') }}" class="d-flex gap-2 mb-3">
                    <input type="hidden" name="type" value="price">
                    <input type="text" inputmode="decimal" class="form-control" name="value" placeholder="Price to blacklist (e.g. 3{{ cfg.decimal_separator }}50)"
                           required style="max-width: 200px">
                    <button type="submit" class="btn btn-outline-secondary text-nowrap">
                        <i class="bi bi-plus"></i> Add to blacklist
                    </button>
                </form>
                {% set price_blacklist = common_blacklist | selectattr('type', 'equalto', 'price') | list %}
                {% if price_blacklist %}
                <div class="d-flex flex-wrap gap-2">
                    {% for bl in price_blacklist %}
                    <div class="badge bg-warning text-dark border d-inline-flex align-items-center gap-1 px-2 py-2 fs-6 fw-normal">
                        {{ bl.value }}
                        <form method="POST" action="{{ url_for('delete_common_blacklist', item_id=bl.id) }}" class="d-inline m-0">
                            <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-dark lh-1"
                                    title="Remove" onclick="return confirm('Remove {{ bl.value }} from price blacklist?')">
                                <i class="bi bi-x-lg" style="font-size:0.75rem"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">No blacklisted prices.</p>
                {% endif %}
            </div>
        </div>

        <!-- Card 5 — Auto-Collect Schedule -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Auto-Collect Schedule
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('settings_common_auto') }}">

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="common_auto_enabled" name="common_auto_enabled" value="1"
                               {% if cfg.common_auto_enabled == '1' %}checked{% endif %}
                               onchange="toggleCommonAutoFields(this)">
                        <label class="form-check-label" for="common_auto_enabled">
                            Enable auto-collect
                        </label>
                    </div>
                    <div class="form-text mb-3">
                        Automatically promote frequently-used values to the common lists on a schedule.
                    </div>

                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="common_auto_debug" name="common_auto_debug" value="1"
                               {% if cfg.common_auto_debug == '1' %}checked{% endif %}>
                        <label class="form-check-label" for="common_auto_debug">
                            Debug mode — log all decisions to database
                        </label>
                    </div>

                    <div id="common_auto_fields" {% if cfg.common_auto_enabled != '1' %}style="display:none"{% endif %}>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-3 mb-2">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                               id="common_items_auto" name="common_items_auto" value="1"
                                               {% if cfg.common_items_auto == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="common_items_auto">Item names</label>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="form-label mb-0 text-muted small">Min occurrences:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               name="common_items_threshold"
                                               value="{{ cfg.common_items_threshold }}"
                                               min="1" max="999" style="width: 70px">
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-3 mb-2">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                               id="common_descriptions_auto" name="common_descriptions_auto" value="1"
                                               {% if cfg.common_descriptions_auto == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="common_descriptions_auto">Descriptions</label>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="form-label mb-0 text-muted small">Min occurrences:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               name="common_descriptions_threshold"
                                               value="{{ cfg.common_descriptions_threshold }}"
                                               min="1" max="999" style="width: 70px">
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                               id="common_prices_auto" name="common_prices_auto" value="1"
                                               {% if cfg.common_prices_auto == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="common_prices_auto">Prices</label>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="form-label mb-0 text-muted small">Min occurrences:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               name="common_prices_threshold"
                                               value="{{ cfg.common_prices_threshold }}"
                                               min="1" max="999" style="width: 70px">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Run</label>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <select class="form-select w-auto" name="common_auto_day">
                                    <option value="*"   {% if cfg.common_auto_day == '*'   %}selected{% endif %}>Every day</option>
                                    <option value="mon" {% if cfg.common_auto_day == 'mon' %}selected{% endif %}>Monday</option>
                                    <option value="tue" {% if cfg.common_auto_day == 'tue' %}selected{% endif %}>Tuesday</option>
                                    <option value="wed" {% if cfg.common_auto_day == 'wed' %}selected{% endif %}>Wednesday</option>
                                    <option value="thu" {% if cfg.common_auto_day == 'thu' %}selected{% endif %}>Thursday</option>
                                    <option value="fri" {% if cfg.common_auto_day == 'fri' %}selected{% endif %}>Friday</option>
                                    <option value="sat" {% if cfg.common_auto_day == 'sat' %}selected{% endif %}>Saturday</option>
                                    <option value="sun" {% if cfg.common_auto_day == 'sun' %}selected{% endif %}>Sunday</option>
                                </select>
                                <span class="text-muted">at</span>
                                <select class="form-select w-auto" name="common_auto_hour">
                                    {% for h in range(24) %}
                                    <option value="{{ h }}" {% if cfg.common_auto_hour|int == h %}selected{% endif %}>
                                        {{ '%02d'|format(h) }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <span class="fw-bold fs-5">:</span>
                                <select class="form-select w-auto" name="common_auto_minute">
                                    {% set stored_min = (cfg.common_auto_minute|int // 5) * 5 %}
                                    {% for m in range(0, 60, 5) %}
                                    <option value="{{ m }}" {% if stored_min == m %}selected{% endif %}>
                                        {{ '%02d'|format(m) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        {% if cfg.common_auto_enabled == '1' %}
                        {% set auto_day_labels = {'*': 'every day', 'mon': 'every Monday',
                                                  'tue': 'every Tuesday', 'wed': 'every Wednesday',
                                                  'thu': 'every Thursday', 'fri': 'every Friday',
                                                  'sat': 'every Saturday', 'sun': 'every Sunday'} %}
                        <div class="alert alert-success py-2 mb-3">
                            <i class="bi bi-check-circle"></i>
                            Auto-collect runs <strong>{{ auto_day_labels.get(cfg.common_auto_day, cfg.common_auto_day) }}</strong>
                            at <strong>{{ '%02d:%02d'|format(cfg.common_auto_hour|int, cfg.common_auto_minute|int) }}</strong>
                            <span class="text-muted">({{ cfg.timezone }})</span>.
                        </div>
                        {% endif %}

                    </div><!-- /common_auto_fields -->

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-floppy"></i> Save Auto-Collect
                        </button>
                    </div>
                </form>

                <form method="POST" action="{{ url_for('settings_common_auto_run') }}" class="mt-2">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-play-fill"></i> Run Now
                    </button>
                </form>

                {% if cfg.common_auto_debug == '1' %}
                <hr class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-muted">Debug Log</h6>
                    <form method="POST" action="{{ url_for('settings_common_auto_clear_log') }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Clear the entire debug log?')">
                            <i class="bi bi-trash"></i> Clear Log
                        </button>
                    </form>
                </div>
                {% if auto_collect_logs %}
                <pre class="bg-dark text-light p-3 rounded small" style="max-height: 400px; overflow-y: auto; font-size: 0.78rem;">{% for log in auto_collect_logs %}{{ log.ran_at.strftime('%Y-%m-%d %H:%M') }} [{{ log.level|upper }}] {{ '%-12s'|format(log.category) }} {{ log.message }}
{% endfor %}</pre>
                {% else %}
                <p class="text-muted small">No log entries yet. Run auto-collect to generate log entries.</p>
                {% endif %}
                {% endif %}

            </div>
        </div>

    </div><!-- /tab-common-items -->

    <!-- ── Backup tab ── -->
    <div class="tab-pane fade" id="tab-backup">

        <!-- Card 1 — Backups list + Create Now -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-archive"></i> Backups</span>
                <form method="POST" action="{{ url_for('settings_backup_create') }}">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="bi bi-plus-circle"></i> Create Backup Now
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if backups %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Size</th>
                                <th>Created</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in backups %}
                            <tr>
                                <td class="font-monospace small">{{ b.filename }}</td>
                                <td class="text-muted small">
                                    {% set mb = b.size / 1048576 %}
                                    {% if mb >= 1 %}{{ '%.1f'|format(mb) }} MB
                                    {% else %}{{ '%.0f'|format(b.size / 1024) }} KB{% endif %}
                                </td>
                                <td class="text-muted small">{{ b.modified.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="text-end">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <a href="{{ url_for('backup_download', filename=b.filename) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-success"
                                                onclick="confirmRestore('{{ b.filename }}')">
                                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                                        </button>
                                        <form method="POST" action="{{ url_for('backup_delete', filename=b.filename) }}"
                                              class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Delete {{ b.filename }}?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No backups yet. Click "Create Backup Now" to create your first one.</p>
                {% endif %}
            </div>
        </div>

        <!-- Hidden restore form (submitted by JS) -->
        <form id="restoreForm" method="POST" action="" style="display:none"></form>

        <!-- Card 2 — Upload & Restore -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-upload"></i> Upload Backup
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload a <code>bot_backup_*.tar.gz</code> file. Large files are sent in chunks
                    so there is no size limit.
                </p>

                <div class="mb-3">
                    <input type="file" class="form-control" id="backupFileInput" accept=".tar.gz,.gz">
                </div>

                <button type="button" class="btn btn-primary" id="uploadBtn" onclick="startChunkedUpload()">
                    <i class="bi bi-upload"></i> Upload
                </button>

                <div id="uploadProgress" class="mt-3" style="display:none">
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="uploadProgressBar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted" id="uploadStatus">Preparing…</small>
                </div>
            </div>
        </div>

        <!-- Card 3 — Auto-Schedule -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock"></i> Auto-Backup Schedule
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('settings_backup') }}">

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="backup_enabled" name="backup_enabled" value="1"
                               {% if cfg.backup_enabled == '1' %}checked{% endif %}
                               onchange="toggleBackupFields(this)">
                        <label class="form-check-label" for="backup_enabled">
                            Enable automatic backups
                        </label>
                    </div>
                    <div class="form-text mb-3">
                        Automatically create a backup on the configured schedule.
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="backup_debug" name="backup_debug" value="1"
                               {% if cfg.backup_debug == '1' %}checked{% endif %}>
                        <label class="form-check-label" for="backup_debug">
                            Debug mode — log backup runs to database
                        </label>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="backup_admin_email" name="backup_admin_email" value="1"
                                   {% if cfg.backup_admin_email == '1' %}checked{% endif %}
                                   {% if not cfg.site_admin_id %}disabled{% endif %}>
                            <label class="form-check-label" for="backup_admin_email">
                                Send backup status email to site admin
                            </label>
                        </div>
                        <div class="form-text">
                            {% if cfg.site_admin_id %}
                                After each <strong>scheduled</strong> backup, send a status report to the site admin. Manual backups do not trigger this email.
                            {% else %}
                                No site admin is configured. Set one in <strong>General</strong> to enable this option.
                            {% endif %}
                        </div>
                    </div>

                    <div id="backup_schedule_fields" {% if cfg.backup_enabled != '1' %}style="display:none"{% endif %}>

                        <div class="mb-3">
                            <label class="form-label">Run</label>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <select class="form-select w-auto" name="backup_day">
                                    <option value="*"   {% if cfg.backup_day == '*'   %}selected{% endif %}>Every day</option>
                                    <option value="mon" {% if cfg.backup_day == 'mon' %}selected{% endif %}>Monday</option>
                                    <option value="tue" {% if cfg.backup_day == 'tue' %}selected{% endif %}>Tuesday</option>
                                    <option value="wed" {% if cfg.backup_day == 'wed' %}selected{% endif %}>Wednesday</option>
                                    <option value="thu" {% if cfg.backup_day == 'thu' %}selected{% endif %}>Thursday</option>
                                    <option value="fri" {% if cfg.backup_day == 'fri' %}selected{% endif %}>Friday</option>
                                    <option value="sat" {% if cfg.backup_day == 'sat' %}selected{% endif %}>Saturday</option>
                                    <option value="sun" {% if cfg.backup_day == 'sun' %}selected{% endif %}>Sunday</option>
                                </select>
                                <span class="text-muted">at</span>
                                <select class="form-select w-auto" name="backup_hour">
                                    {% for h in range(24) %}
                                    <option value="{{ h }}" {% if cfg.backup_hour|int == h %}selected{% endif %}>
                                        {{ '%02d'|format(h) }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <span class="fw-bold fs-5">:</span>
                                <select class="form-select w-auto" name="backup_minute">
                                    {% set stored_bmin = (cfg.backup_minute|int // 5) * 5 %}
                                    {% for m in range(0, 60, 5) %}
                                    <option value="{{ m }}" {% if stored_bmin == m %}selected{% endif %}>
                                        {{ '%02d'|format(m) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="backup_keep" class="form-label">Keep last</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" class="form-control" id="backup_keep" name="backup_keep"
                                       value="{{ cfg.backup_keep }}" min="1" max="365" style="width: 90px">
                                <span class="text-muted">backups (older ones are deleted automatically)</span>
                            </div>
                        </div>

                        {% if cfg.backup_enabled == '1' %}
                        {% set bday_labels = {'*': 'every day', 'mon': 'every Monday',
                                              'tue': 'every Tuesday', 'wed': 'every Wednesday',
                                              'thu': 'every Thursday', 'fri': 'every Friday',
                                              'sat': 'every Saturday', 'sun': 'every Sunday'} %}
                        <div class="alert alert-success py-2 mb-3">
                            <i class="bi bi-check-circle"></i>
                            Backups run <strong>{{ bday_labels.get(cfg.backup_day, cfg.backup_day) }}</strong>
                            at <strong>{{ '%02d:%02d'|format(cfg.backup_hour|int, cfg.backup_minute|int) }}</strong>
                            <span class="text-muted">({{ cfg.timezone }})</span>.
                        </div>
                        {% endif %}

                    </div><!-- /backup_schedule_fields -->

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-floppy"></i> Save Schedule
                    </button>
                </form>
            </div>
        </div>

        {% if cfg.backup_debug == '1' %}
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-text"></i> Backup Debug Log</span>
                <form method="POST" action="{{ url_for('settings_backup_clear_log') }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Clear the entire backup debug log?')">
                        <i class="bi bi-trash"></i> Clear Log
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if backup_logs %}
                <pre class="bg-dark text-light p-3 rounded small mb-0" style="max-height: 400px; overflow-y: auto; font-size: 0.78rem;">{% for log in backup_logs %}{{ log.ran_at.strftime('%Y-%m-%d %H:%M') }} [{{ log.level|upper }}] {{ log.message }}
{% endfor %}</pre>
                {% else %}
                <p class="text-muted small mb-0">No log entries yet.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div><!-- /tab-backup -->

    <!-- ── Templates tab ── -->
    <div class="tab-pane fade" id="tab-templates">
        <form method="POST" action="{{ url_for('settings_templates') }}">

            <!-- Colors / Theme -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-palette"></i> Colors &amp; Theme
                </div>
                <div class="card-body">
                    <!-- Preset selector -->
                    <div class="mb-4">
                        <label class="form-label">Preset theme</label>
                        <select class="form-select" id="theme_preset" style="max-width: 220px"
                                onchange="applyThemePreset(this.value)">
                            <option value="custom" {% if current_theme == 'custom' %}selected{% endif %}>— Custom —</option>
                            {% for key, theme in themes.items() %}
                            <option value="{{ key }}" {% if current_theme == key %}selected{% endif %}>{{ theme.label }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecting a preset fills all color pickers below. Changing any picker switches to Custom.</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-sm-6 col-lg-4">
                            <label for="color_navbar" class="form-label">Navbar color</label>
                            <div class="input-group" style="max-width: 240px">
                                <input type="color" class="form-control form-control-color"
                                       id="color_navbar" name="color_navbar"
                                       value="{{ cfg.color_navbar }}"
                                       onchange="setCustomTheme()">
                                <input type="text" class="form-control font-monospace"
                                       id="color_navbar_hex" value="{{ cfg.color_navbar }}"
                                       maxlength="7" style="max-width: 90px"
                                       oninput="syncHexInput(this, 'color_navbar')">
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <label for="color_email_grad_start" class="form-label">Email gradient start</label>
                            <div class="input-group" style="max-width: 240px">
                                <input type="color" class="form-control form-control-color"
                                       id="color_email_grad_start" name="color_email_grad_start"
                                       value="{{ cfg.color_email_grad_start }}"
                                       onchange="setCustomTheme()">
                                <input type="text" class="form-control font-monospace"
                                       id="color_email_grad_start_hex" value="{{ cfg.color_email_grad_start }}"
                                       maxlength="7" style="max-width: 90px"
                                       oninput="syncHexInput(this, 'color_email_grad_start')">
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <label for="color_email_grad_end" class="form-label">Email gradient end</label>
                            <div class="input-group" style="max-width: 240px">
                                <input type="color" class="form-control form-control-color"
                                       id="color_email_grad_end" name="color_email_grad_end"
                                       value="{{ cfg.color_email_grad_end }}"
                                       onchange="setCustomTheme()">
                                <input type="text" class="form-control font-monospace"
                                       id="color_email_grad_end_hex" value="{{ cfg.color_email_grad_end }}"
                                       maxlength="7" style="max-width: 90px"
                                       oninput="syncHexInput(this, 'color_email_grad_end')">
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <label for="color_balance_positive" class="form-label">Positive balance color</label>
                            <div class="input-group" style="max-width: 240px">
                                <input type="color" class="form-control form-control-color"
                                       id="color_balance_positive" name="color_balance_positive"
                                       value="{{ cfg.color_balance_positive }}"
                                       onchange="setCustomTheme()">
                                <input type="text" class="form-control font-monospace"
                                       id="color_balance_positive_hex" value="{{ cfg.color_balance_positive }}"
                                       maxlength="7" style="max-width: 90px"
                                       oninput="syncHexInput(this, 'color_balance_positive')">
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <label for="color_balance_negative" class="form-label">Negative balance color</label>
                            <div class="input-group" style="max-width: 240px">
                                <input type="color" class="form-control form-control-color"
                                       id="color_balance_negative" name="color_balance_negative"
                                       value="{{ cfg.color_balance_negative }}"
                                       onchange="setCustomTheme()">
                                <input type="text" class="form-control font-monospace"
                                       id="color_balance_negative_hex" value="{{ cfg.color_balance_negative }}"
                                       maxlength="7" style="max-width: 90px"
                                       oninput="syncHexInput(this, 'color_balance_negative')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Email template -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-envelope"></i> Weekly Balance Email</span>
                    <a href="{{ url_for('preview_email') }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-eye"></i> Preview
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Available placeholders: <code>[Name]</code> <code>[Balance]</code> <code>[BalanceStatus]</code> <code>[Date]</code>
                        &nbsp;— Leave a body field blank to omit that line from the email.
                    </p>
                    <div class="mb-3">
                        <label for="tpl_email_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="tpl_email_subject"
                               name="tpl_email_subject" value="{{ cfg.tpl_email_subject }}"
                               placeholder="Bank of Tina - Weekly Balance Update ([Date])">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_email_greeting" class="form-label">Greeting</label>
                        <input type="text" class="form-control" id="tpl_email_greeting"
                               name="tpl_email_greeting" value="{{ cfg.tpl_email_greeting }}"
                               placeholder="Hi [Name],">
                        <div class="form-text">First line of the email body.</div>
                    </div>
                    <div class="mb-3">
                        <label for="tpl_email_intro" class="form-label">Intro line</label>
                        <input type="text" class="form-control" id="tpl_email_intro"
                               name="tpl_email_intro" value="{{ cfg.tpl_email_intro }}"
                               placeholder="Here's your weekly update from the Bank of Tina:">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_email_footer1" class="form-label">Footer line 1</label>
                        <input type="text" class="form-control" id="tpl_email_footer1"
                               name="tpl_email_footer1" value="{{ cfg.tpl_email_footer1 }}"
                               placeholder="This is an automated weekly update from the Bank of Tina system.">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_email_footer2" class="form-label">Footer line 2</label>
                        <input type="text" class="form-control" id="tpl_email_footer2"
                               name="tpl_email_footer2" value="{{ cfg.tpl_email_footer2 }}"
                               placeholder="Making office lunches easier! 🥗">
                    </div>
                </div>
            </div>

            <!-- Admin Summary Email template -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-person-badge"></i> Admin Summary Email</span>
                    <a href="{{ url_for('preview_admin_summary') }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-eye"></i> Preview
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Available placeholders: <code>[Date]</code> <code>[UserCount]</code>
                        &nbsp;— Leave a body field blank to omit that line.
                    </p>
                    <div class="mb-3">
                        <label for="tpl_admin_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="tpl_admin_subject"
                               name="tpl_admin_subject" value="{{ cfg.tpl_admin_subject }}"
                               placeholder="Bank of Tina - Admin Summary ([Date])">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_admin_intro" class="form-label">Intro line</label>
                        <input type="text" class="form-control" id="tpl_admin_intro"
                               name="tpl_admin_intro" value="{{ cfg.tpl_admin_intro }}"
                               placeholder="(optional intro above the table)">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_admin_footer" class="form-label">Footer</label>
                        <input type="text" class="form-control" id="tpl_admin_footer"
                               name="tpl_admin_footer" value="{{ cfg.tpl_admin_footer }}"
                               placeholder="This is an automated admin summary from the Bank of Tina system.">
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="admin_summary_include_emails" name="admin_summary_include_emails" value="1"
                                   {% if cfg.admin_summary_include_emails == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="admin_summary_include_emails">
                                Include email addresses in summary table
                            </label>
                        </div>
                        <div class="form-text">When off, only names and balances are shown. Default: off.</div>
                    </div>
                </div>
            </div>

            <!-- Backup Status Email template -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-archive"></i> Backup Status Email</span>
                    <a href="{{ url_for('preview_backup') }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-eye"></i> Preview
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Available placeholders: <code>[Date]</code> <code>[BackupStatus]</code>
                        &nbsp;— Leave the footer blank to omit it.
                    </p>
                    <div class="mb-3">
                        <label for="tpl_backup_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="tpl_backup_subject"
                               name="tpl_backup_subject" value="{{ cfg.tpl_backup_subject }}"
                               placeholder="Bank of Tina - Backup [BackupStatus] ([Date])">
                    </div>
                    <div class="mb-3">
                        <label for="tpl_backup_footer" class="form-label">Footer</label>
                        <input type="text" class="form-control" id="tpl_backup_footer"
                               name="tpl_backup_footer" value="{{ cfg.tpl_backup_footer }}"
                               placeholder="This is an automated backup report from the Bank of Tina system.">
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-floppy"></i> Save Templates
                </button>
                <button type="button" class="btn btn-outline-secondary"
                        onclick="if(confirm('Reset all templates and colors to defaults?')) { document.getElementById('reset-templates-form').submit(); }">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                </button>
            </div>
        </form>

        <form id="reset-templates-form" method="POST"
              action="{{ url_for('settings_templates_reset') }}" class="d-none"></form>

        <!-- App Icon -->
        <div class="card mb-4 mt-4">
            <div class="card-header">
                <i class="bi bi-image"></i> App Icon
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Current icon</label>
                    <div>
                        <img src="/static/icons/icon-192.png?v={{ icon_version }}" alt="Current app icon"
                             style="width: 96px; height: 96px; border-radius: 12px; border: 1px solid #dee2e6;"
                             id="icon-preview">
                    </div>
                </div>

                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <div class="fw-semibold mb-1">Generate from theme</div>
                        <p class="text-muted small mb-2">
                            Uses current navbar color as background with the bank silhouette in white.
                        </p>
                        <form method="POST" action="{{ url_for('settings_icon') }}">
                            <input type="hidden" name="action" value="generate">
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bi bi-arrow-repeat"></i> Regenerate with Navbar Color
                            </button>
                        </form>
                    </div>
                </div>

                <div class="text-center text-muted mb-3">&mdash; or &mdash;</div>

                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <div class="fw-semibold mb-1">Upload custom icon</div>
                        <p class="text-muted small mb-2">
                            PNG or JPG, will be resized to 192&times;192 and 512&times;512.
                        </p>
                        <form method="POST" action="{{ url_for('settings_icon') }}" enctype="multipart/form-data">
                            <input type="hidden" name="action" value="upload">
                            <div class="d-flex gap-2 align-items-center">
                                <input type="file" class="form-control form-control-sm" name="icon_file"
                                       accept=".png,.jpg,.jpeg" style="max-width: 280px;">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="bi bi-upload"></i> Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <form method="POST" action="{{ url_for('settings_icon') }}">
                    <input type="hidden" name="action" value="reset">
                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                </form>
            </div>
        </div>

    </div><!-- /tab-templates -->

    <!-- ── Users tab ── -->
    <div class="tab-pane fade" id="tab-users">

        <!-- Add User -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-person-plus"></i> Add User
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_user') }}" class="row g-3">
                    <div class="col-sm-6">
                        <label for="new_user_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="new_user_name" name="name" required>
                    </div>
                    <div class="col-sm-6">
                        <label for="new_user_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="new_user_email" name="email" required>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <label class="form-label">Weekly email report</label>
                        <div class="form-check form-switch mt-1">
                            <input class="form-check-input" type="checkbox" name="email_opt_in"
                                   value="1" id="new_user_email_opt_in" checked>
                            <label class="form-check-label" for="new_user_email_opt_in">
                                Send weekly balance email
                            </label>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <label for="new_user_email_transactions" class="form-label">Include in email</label>
                        <select class="form-select" name="email_transactions" id="new_user_email_transactions">
                            <option value="none">No transactions</option>
                            <option value="last3" selected>Last 3 transactions</option>
                            <option value="this_week">Transactions this week</option>
                            <option value="this_month">Transactions this month</option>
                        </select>
                    </div>
                    <div class="col-sm-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Active Users -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people"></i> Active Users
            </div>
            <div class="card-body">
                {% set active_users = all_users|selectattr('is_active')|list %}
                {% if active_users %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th class="text-end">Balance</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in active_users %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('user_detail', user_id=user.id) }}" class="text-decoration-none">
                                        <strong>{{ user.name }}</strong>
                                    </a>
                                </td>
                                <td class="text-muted">{{ user.email }}</td>
                                <td class="text-end">
                                    <span class="{% if user.balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                        <strong>{{ currency_symbol }}{{ user.balance|money }}</strong>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <form method="POST" action="{{ url_for('toggle_user_active', user_id=user.id) }}">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary"
                                                onclick="return confirm('Deactivate {{ user.name }}?')">
                                            <i class="bi bi-person-dash"></i> Deactivate
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No active users. Add your first user above.</p>
                {% endif %}
            </div>
        </div>

        <!-- Deactivated Users (hidden when none exist) -->
        {% set deactivated_users = all_users|rejectattr('is_active')|list %}
        {% if deactivated_users %}
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-person-slash"></i> Deactivated Users
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th class="text-end">Balance</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in deactivated_users %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('user_detail', user_id=user.id) }}" class="text-decoration-none">
                                        <strong>{{ user.name }}</strong>
                                    </a>
                                </td>
                                <td class="text-muted">{{ user.email }}</td>
                                <td class="text-end">
                                    <span class="{% if user.balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                        <strong>{{ currency_symbol }}{{ user.balance|money }}</strong>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <form method="POST" action="{{ url_for('toggle_user_active', user_id=user.id) }}">
                                        <button type="submit" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-person-check"></i> Reactivate
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </div><!-- /tab-users -->

</div><!-- /tab-content -->
{% endblock %}

{% block scripts %}
<script>
function toggleScheduleFields(checkbox) {
    document.getElementById('schedule_fields').style.display = checkbox.checked ? '' : 'none';
}

function toggleCommonAutoFields(checkbox) {
    document.getElementById('common_auto_fields').style.display = checkbox.checked ? '' : 'none';
}

function toggleBackupFields(checkbox) {
    document.getElementById('backup_schedule_fields').style.display = checkbox.checked ? '' : 'none';
}

function confirmRestore(filename) {
    if (!confirm('Restore from ' + filename + '?\n\nThis will overwrite the current database and all receipt images. This cannot be undone.')) return;
    const form = document.getElementById('restoreForm');
    form.action = '/backups/restore/' + encodeURIComponent(filename);
    form.submit();
}

function startChunkedUpload() {
    const fileInput = document.getElementById('backupFileInput');
    const file = fileInput.files[0];
    if (!file) { alert('Please select a file first.'); return; }

    const CHUNK_SIZE = 5 * 1024 * 1024; // 5 MB
    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
    const uploadId = crypto.randomUUID();

    const btn       = document.getElementById('uploadBtn');
    const progress  = document.getElementById('uploadProgress');
    const bar       = document.getElementById('uploadProgressBar');
    const status    = document.getElementById('uploadStatus');

    btn.disabled = true;
    progress.style.display = '';

    let chunkIndex = 0;

    function uploadNext() {
        if (chunkIndex >= totalChunks) return;

        const start = chunkIndex * CHUNK_SIZE;
        const end   = Math.min(start + CHUNK_SIZE, file.size);
        const chunk = file.slice(start, end);

        const fd = new FormData();
        fd.append('uploadId',    uploadId);
        fd.append('chunkIndex',  chunkIndex);
        fd.append('totalChunks', totalChunks);
        fd.append('chunk',       chunk);

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch('/backups/upload-chunk', { method: 'POST', body: fd, headers: {'X-CSRFToken': csrfToken} })
            .then(r => r.json())
            .then(data => {
                chunkIndex++;
                const pct = Math.round((chunkIndex / totalChunks) * 100);
                bar.style.width = pct + '%';
                bar.textContent = pct + '%';
                status.textContent = `Uploading… chunk ${chunkIndex} of ${totalChunks}`;

                if (data.done) {
                    bar.classList.remove('progress-bar-animated');
                    status.textContent = 'Upload complete: ' + data.filename;
                    btn.disabled = false;
                    setTimeout(() => location.reload(), 1200);
                } else {
                    uploadNext();
                }
            })
            .catch(err => {
                status.textContent = 'Upload error: ' + err;
                btn.disabled = false;
            });
    }

    uploadNext();
}

// Persist active tab across redirects (e.g. after saving common items)
const STORAGE_KEY = 'settingsActiveTab';
const defaultTab  = '#tab-general';

function activateTab(targetId) {
    const btn = document.querySelector(`[data-bs-target="${targetId}"]`);
    if (btn) bootstrap.Tab.getOrCreateInstance(btn).show();
}

// Save tab choice whenever the user switches
document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', e => {
        sessionStorage.setItem(STORAGE_KEY, e.target.dataset.bsTarget);
    });
});

// Restore on load — honour ?tab= URL param first, then sessionStorage, then default
const urlTab = new URLSearchParams(window.location.search).get('tab');
activateTab(urlTab ? '#tab-' + urlTab : (sessionStorage.getItem(STORAGE_KEY) || defaultTab));

// ── Templates: theme preset / color picker logic ───────────────────────────

const THEMES = {{ themes | tojson }};

function applyThemePreset(key) {
    if (key === 'custom') return;
    const t = THEMES[key];
    if (!t) return;
    const colorFields = ['color_navbar', 'color_email_grad_start', 'color_email_grad_end',
                         'color_balance_positive', 'color_balance_negative'];
    colorFields.forEach(function(field) {
        const picker = document.getElementById(field);
        const hex    = document.getElementById(field + '_hex');
        if (picker && t[field]) { picker.value = t[field]; }
        if (hex    && t[field]) { hex.value    = t[field]; }
    });
}

function setCustomTheme() {
    const sel = document.getElementById('theme_preset');
    if (sel) sel.value = 'custom';
}

function syncHexInput(hexInput, pickerName) {
    // When user types a valid hex value into the text box, update the color picker
    const val = hexInput.value.trim();
    if (/^#[0-9a-fA-F]{6}$/.test(val)) {
        const picker = document.getElementById(pickerName);
        if (picker) picker.value = val;
        setCustomTheme();
    }
}
</script>
{% endblock %}
