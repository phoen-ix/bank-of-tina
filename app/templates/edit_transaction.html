{% extends "base.html" %}

{% block title %}Edit Transaction - Bank of Tina{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pencil"></i> Edit Transaction #{{ trans.id }}
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('edit_transaction', transaction_id=trans.id) }}" id="editForm">
                    <input type="hidden" id="items_json" name="items_json">
                    <datalist id="commonItemsList"></datalist>

                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-control" value="{{ trans.transaction_type }}" disabled>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description"
                               value="{{ trans.description }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (€)</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="amount" name="amount"
                               value="{{ '%.2f'|format(trans.amount) }}" required>
                        <div id="amountNote" class="form-text" style="display:none">
                            Auto-calculated from items below.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="date" class="form-label">Date &amp; Time</label>
                        <input type="datetime-local" class="form-control" id="date" name="date"
                               value="{{ trans.date.strftime('%Y-%m-%dT%H:%M') }}">
                    </div>

                    <div class="mb-3">
                        <label for="from_user_id" class="form-label">From user</label>
                        <select class="form-select" id="from_user_id" name="from_user_id">
                            <option value="">— none / system —</option>
                            {% for u in users %}
                                <option value="{{ u.id }}"
                                    {% if trans.from_user_id == u.id %}selected{% endif %}>
                                    {{ u.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="to_user_id" class="form-label">To user</label>
                        <select class="form-select" id="to_user_id" name="to_user_id">
                            <option value="">— none / system —</option>
                            {% for u in users %}
                                <option value="{{ u.id }}"
                                    {% if trans.to_user_id == u.id %}selected{% endif %}>
                                    {{ u.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Expense Items -->
                    <div class="mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-list-ul"></i> Expense Items</span>
                                <button type="button" class="btn btn-sm btn-success" onclick="addItemRow()">
                                    <i class="bi bi-plus"></i> Add Item
                                </button>
                            </div>
                            <div class="card-body pb-2">
                                <div id="itemsContainer"></div>
                                <p id="noItemsMsg" class="text-muted small mb-2">
                                    No items. Click "Add Item" to attach expense line items.
                                </p>
                                <div class="text-end">
                                    <strong>Items total: €<span id="itemsTotal">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-floppy"></i> Save Changes
                        </button>
                        <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let rowCounter = 0;

// Existing items from the server
const initialItems = [
    {% for item in trans.items %}
    { name: {{ item.item_name | tojson }}, price: {{ item.price }} }{% if not loop.last %},{% endif %}
    {% endfor %}
];

function escAttr(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function addItemRow(name = '', price = '') {
    rowCounter++;
    const id = rowCounter;
    const row = document.createElement('div');
    row.className = 'row g-2 mb-2 item-row align-items-center';
    row.id = 'itemRow_' + id;
    row.innerHTML =
        '<div class="col">' +
            '<input type="text" class="form-control form-control-sm item-name" placeholder="Item name"' +
            ' list="commonItemsList" value="' + escAttr(name) + '">' +
        '</div>' +
        '<div class="col-auto" style="width:130px">' +
            '<div class="input-group input-group-sm">' +
                '<span class="input-group-text">€</span>' +
                '<input type="number" class="form-control item-price" placeholder="0.00"' +
                ' step="0.01" min="0.01" value="' + escAttr(price) + '" oninput="syncTotal()">' +
            '</div>' +
        '</div>' +
        '<div class="col-auto">' +
            '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(' + id + ')">' +
                '<i class="bi bi-trash"></i>' +
            '</button>' +
        '</div>';
    document.getElementById('itemsContainer').appendChild(row);
    document.getElementById('noItemsMsg').style.display = 'none';
    syncTotal();
}

function removeItemRow(id) {
    document.getElementById('itemRow_' + id).remove();
    const hasRows = document.querySelectorAll('.item-row').length > 0;
    document.getElementById('noItemsMsg').style.display = hasRows ? 'none' : '';
    syncTotal();
}

function syncTotal() {
    let total = 0;
    document.querySelectorAll('.item-price').forEach(el => {
        total += parseFloat(el.value) || 0;
    });
    document.getElementById('itemsTotal').textContent = total.toFixed(2);

    const hasItems = document.querySelectorAll('.item-row').length > 0;
    if (hasItems) {
        document.getElementById('amount').value = total.toFixed(2);
        document.getElementById('amountNote').style.display = '';
    } else {
        document.getElementById('amountNote').style.display = 'none';
    }
}

document.getElementById('editForm').addEventListener('submit', function() {
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const name  = row.querySelector('.item-name').value.trim();
        const price = row.querySelector('.item-price').value;
        if (name && price) {
            items.push({ name, price });
        }
    });
    document.getElementById('items_json').value = items.length ? JSON.stringify(items) : '';
});

// Populate common items datalist
fetch('/api/common-items')
    .then(r => r.json())
    .then(items => {
        const dl = document.getElementById('commonItemsList');
        items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.name;
            dl.appendChild(opt);
        });
    });

// Pre-populate with existing items
initialItems.forEach(item => addItemRow(item.name, item.price));
</script>
{% endblock %}
